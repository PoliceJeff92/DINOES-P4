<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGEF - Logística DINOES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#3b82f6',
                        accent: '#ef4444',
                        dark: '#0f172a',
                        success: '#10b981',
                        warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .sidebar-link.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        canvas { max-height: 200px !important; }
        .card-dash { background: white; border-radius: 12px; padding: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="min-h-screen flex flex-col text-gray-800">

    <nav class="bg-dark text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i class="fas fa-shield-alt text-2xl text-blue-500"></i>
                <h1 class="text-sm md:text-lg font-bold uppercase tracking-tight">Logística DINOES</h1>
            </div>
            <div class="bg-gray-800 rounded px-3 py-1">
                <select id="global-unit-filter" onchange="applyGlobalFilter()" class="bg-transparent text-white text-xs font-bold outline-none">
                    <option value="ALL">UNIDAD NACIONAL</option>
                    <option value="DINOES" class="text-dark">DINOES</option>
                    <option value="UNOE" class="text-dark">UNOE</option>
                    <option value="AEROPOLICIAL" class="text-dark">AEROPOLICIAL</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 flex-col md:flex-row">
        <aside class="w-full md:w-60 bg-white border-r border-gray-200 p-4 space-y-1">
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-th-large w-5"></i><span>Dashboard</span>
            </button>
            <div class="text-[10px] font-bold text-gray-400 uppercase mt-4 mb-2 px-3">Inventarios</div>
            <button onclick="switchTab('vehiculos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-car w-5"></i><span>Vehículos</span>
            </button>
            <button onclick="switchTab('armamento')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-gun w-5"></i><span>Armamento / CS</span>
            </button>
            <button onclick="switchTab('equinos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-horse w-5"></i><span>Equinos</span>
            </button>
            <button onclick="switchTab('canes')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-dog w-5"></i><span>Canes</span>
            </button>
            <button onclick="switchTab('contratos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600">
                <i class="fas fa-file-signature w-5"></i><span>Contratos</span>
            </button>
            <div class="pt-4 mt-4 border-t border-gray-100">
                <button onclick="updateData()" class="w-full bg-primary text-white py-2 rounded-lg text-xs font-bold flex items-center justify-center space-x-2">
                    <i class="fas fa-sync" id="sync-icon"></i><span>SINCRONIZAR</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-6 overflow-y-auto">
            
            <div id="dashboard" class="tab-content active space-y-6">
                <h2 class="text-xl font-bold">Resumen General: <span id="display-unit" class="text-blue-600">NACIONAL</span></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="card-dash">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Flota Vehicular</h3>
                        <canvas id="chartVehiculos"></canvas>
                    </div>
                    <div class="card-dash">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Armamento (Estado)</h3>
                        <canvas id="chartArmamento"></canvas>
                    </div>
                    <div class="card-dash">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Canes vs Equinos</h3>
                        <canvas id="chartSemovientes"></canvas>
                    </div>
                    <div class="card-dash">
                        <h3 class="text-xs font-bold text-gray-500 uppercase mb-3">Contratos</h3>
                        <canvas id="chartContratos"></canvas>
                    </div>
                </div>
            </div>

            <div id="armamento" class="tab-content space-y-8">
                <h2 class="text-xl font-bold">Armamento y Material CS</h2>
                <div class="bg-white rounded-xl shadow border">
                    <div class="bg-blue-600 text-white px-4 py-2 text-xs font-bold rounded-t-xl">TABLA: ARMAMENTO</div>
                    <div class="table-container"><table class="w-full text-left text-xs"><tbody id="tabla-armas" class="divide-y"></tbody></table></div>
                </div>
                <div class="bg-white rounded-xl shadow border">
                    <div class="bg-orange-500 text-white px-4 py-2 text-xs font-bold rounded-t-xl">TABLA: MUNICIÓN</div>
                    <div class="table-container"><table class="w-full text-left text-xs"><tbody id="tabla-municion" class="divide-y"></tbody></table></div>
                </div>
                <div class="bg-white rounded-xl shadow border">
                    <div class="bg-green-600 text-white px-4 py-2 text-xs font-bold rounded-t-xl">TABLA: MATERIAL CS</div>
                    <div class="table-container"><table class="w-full text-left text-xs"><tbody id="tabla-materialcs" class="divide-y"></tbody></table></div>
                </div>
            </div>

            <div id="vehiculos" class="tab-content">
                <div class="bg-white rounded-xl shadow border p-4">
                    <h2 class="text-xl font-bold mb-4">Parque Automotor</h2>
                    <div class="table-container">
                        <table class="w-full text-left text-xs">
                            <thead class="bg-gray-100 uppercase font-bold text-gray-600">
                                <tr><th class="px-4 py-2">Vehículo</th><th class="px-4 py-2">Unidad</th><th class="px-4 py-2">Estado</th></tr>
                            </thead>
                            <tbody id="tabla-vehiculos" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="equinos" class="tab-content"><div class="bg-white p-4 rounded-xl shadow border"><h2 class="font-bold mb-4">Equinos</h2><div class="table-container"><table class="w-full text-xs text-left"><tbody id="tabla-equinos" class="divide-y"></tbody></table></div></div></div>
            <div id="canes" class="tab-content"><div class="bg-white p-4 rounded-xl shadow border"><h2 class="font-bold mb-4">Canes</h2><div class="table-container"><table class="w-full text-xs text-left"><tbody id="tabla-canes" class="divide-y"></tbody></table></div></div></div>
            <div id="contratos" class="tab-content"><div class="bg-white p-4 rounded-xl shadow border"><h2 class="font-bold mb-4">Contratos</h2><div class="table-container"><table class="w-full text-xs text-left"><tbody id="tabla-contratos" class="divide-y"></tbody></table></div></div></div>

        </main>
    </div>

    <script>
        let charts = {};
        let rawData = null;
        const API_URL = 'https://script.google.com/macros/s/AKfycbzKzM_A-fa5NHn0unv0O3JYiOdZySWalcZ4py9elbwC4A1JlMNXCtlE_K1FjQ8MxWQ/exec';

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const btn = Array.from(document.querySelectorAll('.sidebar-link')).find(b => b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
        }

        async function updateData() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('animate-spin');
            try {
                const response = await fetch(API_URL);
                const data = await response.json();
                if(data.status === "success") {
                    rawData = data;
                    applyGlobalFilter();
                }
            } catch (e) {
                alert("Error sincronizando");
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function applyGlobalFilter() {
            if (!rawData) return;
            const unit = document.getElementById('global-unit-filter').value;
            const matchesUnit = (item) => unit === 'ALL' || String(item.Unidad).toUpperCase() === unit.toUpperCase();

            // Filtrado
            const fVeh = rawData.vehiculos.filter(matchesUnit);
            const fArma = rawData.armamento.filter(matchesUnit);
            const fEqui = rawData.equinos.filter(matchesUnit);
            const fCane = rawData.canes.filter(matchesUnit);
            const fCont = rawData.contratos.filter(matchesUnit);

            // Renders
            renderVehiculos(fVeh);
            renderArmamentoEspecial(fArma);
            renderSimpleTable('tabla-equinos', fEqui);
            renderSimpleTable('tabla-canes', fCane);
            renderSimpleTable('tabla-contratos', fCont);

            // Dashboard
            renderDashboard(fVeh, fArma, fEqui, fCane, fCont);
            document.getElementById('display-unit').innerText = unit === 'ALL' ? 'NACIONAL' : unit;
        }

        function renderVehiculos(data) {
            document.getElementById('tabla-vehiculos').innerHTML = data.map(v => `
                <tr><td class="px-4 py-2 font-bold">${v.Placa || 'S/P'}</td><td class="px-4 py-2">${v.Unidad}</td><td class="px-4 py-2">${v.Estado}</td></tr>
            `).join('');
        }

        function renderArmamentoEspecial(data) {
            const armas = data.filter(a => String(a.Categoria).toUpperCase().includes('ARMA'));
            const muni = data.filter(a => String(a.Categoria).toUpperCase().includes('MUNI'));
            const cs = data.filter(a => String(a.Categoria).toUpperCase().includes('CS') || String(a.Categoria).toUpperCase().includes('MATERIAL'));

            const row = (a) => `<tr><td class="px-4 py-2 font-bold">${a.Tipo}</td><td class="px-4 py-2">${a.Unidad}</td><td class="px-4 py-2 font-bold">${a.Cantidad}</td></tr>`;
            
            document.getElementById('tabla-armas').innerHTML = armas.map(row).join('');
            document.getElementById('tabla-municion').innerHTML = muni.map(row).join('');
            document.getElementById('tabla-materialcs').innerHTML = cs.map(row).join('');
        }

        function renderSimpleTable(id, data) {
            document.getElementById(id).innerHTML = data.map(item => `
                <tr><td class="px-4 py-2 font-bold">${item.ID || item.Objeto || 'N/A'}</td><td class="px-4 py-2">${item.Unidad}</td><td class="px-4 py-2">${item.Salud || item.Estado || ''}</td></tr>
            `).join('');
        }

        function renderDashboard(v, a, e, c, k) {
            // Vehiculos (Op vs No Op)
            const vOp = v.filter(x => String(x.Estado).toUpperCase().includes('OPERATIVO')).length;
            createPie('chartVehiculos', ['Op', 'No Op'], [vOp, v.length - vOp], ['#10b981', '#ef4444']);

            // Armamento (Por Estado)
            const aBueno = a.filter(x => String(x.Estado).toUpperCase().includes('BUENO')).length;
            createPie('chartArmamento', ['Bueno', 'Otros'], [aBueno, a.length - aBueno], ['#3b82f6', '#94a3b8']);

            // Semovientes
            createPie('chartSemovientes', ['Equinos', 'Canes'], [e.length, c.length], ['#b45309', '#059669']);

            // Contratos
            const kAct = k.filter(x => String(x.Estado).toUpperCase().includes('ACTIVO')).length;
            createPie('chartContratos', ['Activos', 'Otros'], [kAct, k.length - kAct], ['#8b5cf6', '#cbd5e1']);
        }

        function createPie(id, labels, data, colors) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            charts[id] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{ data: data, backgroundColor: colors }]
                },
                options: { 
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, font: { size: 9 } } } }
                }
            });
        }

        window.onload = updateData;
    </script>
</body>
</html>
