<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGEF - Departamento de Logística DINOES</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1e3a8a',
                        secondary: '#3b82f6',
                        accent: '#ef4444',
                        dark: '#0f172a',
                        success: '#10b981',
                        warning: '#f59e0b',
                        info: '#06b6d4',
                        maintenance: '#8b5cf6',
                        budget: '#f97316'
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link.active { background-color: #3b82f6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .table-container { overflow-x: auto; }
        canvas { max-height: 280px; }
        .status-badge { font-size: 10px; font-weight: 700; padding: 2px 8px; border-radius: 9999px; text-transform: uppercase; }
        .bg-expired { background-color: #fee2e2 !important; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <nav class="bg-dark text-white shadow-xl sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-600 p-2 rounded-lg"><i class="fas fa-shield-alt text-xl"></i></div>
                <div>
                    <h1 class="text-sm md:text-lg font-bold leading-tight uppercase">DIRECCIÓN NACIONAL DE OPERACIONES ESPECIALES Y SERVICIOS ESPECIALIZADOS</h1>
                    <p class="text-[10px] uppercase tracking-widest opacity-70">Departamento de Logística DINOES JJMAV1.0</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-3 bg-gray-800 rounded-lg px-4 py-1.5 border border-gray-700">
                <i class="fas fa-filter text-blue-400 text-xs"></i>
                <select id="global-unit-filter" onchange="applyGlobalFilter()" class="bg-transparent text-white text-xs font-bold focus:outline-none">
                    <option value="ALL" class="text-dark">TODAS LAS UNIDADES</option>
                    <option value="DINOES" class="text-dark font-bold">DINOES</option>
                    <option value="UNOE" class="text-dark font-bold">UNOE</option>
                    <option value="AEROPOLICIAL" class="text-dark font-bold">AEROPOLICIAL</option>
                    <option value="UNIR" class="text-dark">UNIR</option>
                    <option value="UNEMA" class="text-dark">UNEMA</option>
                    <option value="UER" class="text-dark">UER</option>
                    <option value="UNMO" class="text-dark">UNMO</option>
                    <option value="CRAC" class="text-dark">CRAC</option>
                </select>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 flex-col md:flex-row">
        <aside class="w-full md:w-64 bg-white border-r border-gray-200 p-4 space-y-1">
            <p class="text-xs font-semibold text-gray-400 uppercase px-3 mb-2">Principal</p>
            <button onclick="switchTab('dashboard')" class="sidebar-link active w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-chart-pie w-5"></i><span>Dashboard</span>
            </button>
            <p class="text-xs font-semibold text-gray-400 uppercase px-3 mt-4 mb-2">Recursos</p>
            <button onclick="switchTab('vehiculos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-car w-5"></i><span>Vehículos</span>
            </button>
            <button onclick="switchTab('armamento')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-gun w-5"></i><span>Armamento y CS</span>
            </button>
            <button onclick="switchTab('equinos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-horse w-5"></i><span>Equinos</span>
            </button>
            <button onclick="switchTab('canes')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-dog w-5"></i><span>Canes</span>
            </button>
            <p class="text-xs font-semibold text-gray-400 uppercase px-3 mt-4 mb-2">Administración</p>
            <button onclick="switchTab('contratos')" class="sidebar-link w-full flex items-center space-x-3 px-3 py-2 rounded-lg text-gray-600 hover:bg-blue-50 transition-all">
                <i class="fas fa-file-contract w-5"></i><span>Contratos</span>
            </button>
            
            <div class="pt-4 mt-4">
                <button onclick="updateData()" class="w-full flex items-center justify-center space-x-2 px-3 py-3 bg-primary text-white rounded-lg text-xs font-bold hover:bg-blue-800 transition-all">
                    <i class="fas fa-sync-alt" id="sync-icon"></i><span>SINCRONIZAR</span>
                </button>
            </div>
        </aside>

        <main class="flex-1 p-4 md:p-6 overflow-y-auto">
            
            <div id="dashboard" class="tab-content active space-y-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Estado Situacional: <span id="display-unit" class="text-blue-600">UNIDAD NACIONAL</span></h2>
                    <div class="flex items-center space-x-2 bg-white p-2 rounded-lg shadow-sm border border-gray-200">
                        <i class="fas fa-calendar-alt text-gray-400 text-xs"></i>
                        <input type="date" id="date-from" onchange="applyGlobalFilter()" class="text-xs focus:outline-none">
                        <span class="text-gray-400">|</span>
                        <input type="date" id="date-to" onchange="applyGlobalFilter()" class="text-xs focus:outline-none">
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-success">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">Operativos</p>
                        <h3 id="kpi-v-op" class="text-xl font-bold text-success">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-maintenance">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">En Taller</p>
                        <h3 id="kpi-v-maint" class="text-xl font-bold text-maintenance">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-accent">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">Siniestrados</p>
                        <h3 id="kpi-v-crash" class="text-xl font-bold text-accent">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-warning">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">Logística</p>
                        <h3 id="kpi-v-parts" class="text-xl font-bold text-warning">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-orange-600">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">Presupuesto</p>
                        <h3 id="kpi-v-budget" class="text-xl font-bold text-orange-600">0</h3>
                    </div>
                    <div class="bg-white p-4 rounded-xl shadow-sm border-l-4 border-dark">
                        <p class="text-gray-400 text-[10px] font-bold uppercase">Retenidos</p>
                        <h3 id="kpi-v-held" class="text-xl font-bold text-dark">0</h3>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold mb-4 text-gray-700">Estado Operativo de Flota</h3>
                        <div class="relative h-64">
                            <canvas id="chartPieDetail"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold mb-4 text-gray-700">Distribución por Zonas</h3>
                        <div class="relative h-64">
                            <canvas id="chartPieZones"></canvas>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <h3 class="font-bold mb-4 text-gray-700">Recursos por Unidad</h3>
                        <div class="relative h-64">
                            <canvas id="chartZones"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div id="vehiculos" class="tab-content space-y-6">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                    <h2 class="text-xl font-bold text-gray-800">Control de Parque Automotor</h2>
                    <select id="filter-veh-status" onchange="applyGlobalFilter()" class="text-xs border rounded-lg px-2 py-1 focus:ring-2 ring-blue-500">
                        <option value="ALL">Todos los Estados</option>
                        <option value="OPERATIVO">Operativos</option>
                        <option value="MANTENIMIENTO">En Taller</option>
                        <option value="SINIESTRADO">Siniestrados</option>
                        <option value="LOGISTICA">Logística (L/B)</option>
                        <option value="PRESUPUESTO">Falta Presupuesto</option>
                        <option value="RETENIDO">Retenidos</option>
                    </select>
                </div>

                <div class="bg-white rounded-xl shadow-sm border overflow-hidden">
                    <div class="table-container">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b">
                                <tr class="text-[11px] uppercase text-gray-500 tracking-wider">
                                    <th class="px-4 py-3 font-bold">Vehículo</th>
                                    <th class="px-4 py-3 font-bold">Unidad / Zona</th>
                                    <th class="px-4 py-3 font-bold">Estado</th>
                                    <th class="px-4 py-3 font-bold">Tiempo</th>
                                    <th class="px-4 py-3 font-bold">Observaciones</th>
                                </tr>
                            </thead>
                            <tbody id="tabla-vehiculos" class="divide-y"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="armamento" class="tab-content space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Armamento y Material CS</h2>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="table-container"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr class="text-[11px] uppercase text-gray-500 tracking-wider"><th class="px-4 py-3">Categoría</th><th class="px-4 py-3">Tipo</th><th class="px-4 py-3">Unidad</th><th class="px-4 py-3">Cant.</th><th class="px-4 py-3">Estado</th><th class="px-4 py-3">Vencimiento</th></tr></thead><tbody id="tabla-armamento" class="divide-y"></tbody></table></div></div>
            </div>

            <div id="equinos" class="tab-content space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Semovientes Equinos</h2>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="table-container"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr class="text-[11px] uppercase text-gray-500 tracking-wider"><th class="px-4 py-3">ID</th><th class="px-4 py-3">Raza</th><th class="px-4 py-3">Unidad</th><th class="px-4 py-3">Salud</th></tr></thead><tbody id="tabla-equinos" class="divide-y"></tbody></table></div></div>
            </div>

            <div id="canes" class="tab-content space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Semovientes Canes</h2>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="table-container"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr class="text-[11px] uppercase text-gray-500 tracking-wider"><th class="px-4 py-3">ID</th><th class="px-4 py-3">Especialidad</th><th class="px-4 py-3">Unidad</th><th class="px-4 py-3">Salud</th></tr></thead><tbody id="tabla-canes" class="divide-y"></tbody></table></div></div>
            </div>

            <div id="contratos" class="tab-content space-y-6">
                <h2 class="text-xl font-bold text-gray-800">Contratos Logísticos</h2>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden"><div class="table-container"><table class="w-full text-left text-sm"><thead class="bg-gray-50 border-b"><tr class="text-[11px] uppercase text-gray-500 tracking-wider"><th class="px-4 py-3">Objeto</th><th class="px-4 py-3">Responsable</th><th class="px-4 py-3">Inicio</th><th class="px-4 py-3">Fin</th><th class="px-4 py-3">Estado</th></tr></thead><tbody id="tabla-contratos" class="divide-y"></tbody></table></div></div>
            </div>

        </main>
    </div>

    <script>
        let charts = {};
        let rawData = null;
        const today = new Date();
        
        // REEMPLAZA ESTA URL CON LA DE TU NUEVA IMPLEMENTACIÓN
        const API_URL = 'https://script.google.com/macros/s/AKfycbzfqxkI3pBjq0ntIUvNuigIwLTxvQ1d-Du0Czb7iI_2qu9jwDyFpo96GF1WartSP468/exec';

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.sidebar-link').forEach(l => l.classList.remove('active'));
            const btn = Array.from(document.querySelectorAll('.sidebar-link')).find(b => b.onclick.toString().includes(id));
            if(btn) btn.classList.add('active');
        }

        async function updateData() {
            const icon = document.getElementById('sync-icon');
            icon.classList.add('animate-spin');
            try {
                const response = await fetch(`${API_URL}?t=${Date.now()}`);
                const data = await response.json();
                if(data.status === "success") {
                    rawData = data;
                    applyGlobalFilter();
                }
            } catch (e) {
                console.error("Error de sincronización:", e);
                alert("Error al conectar con el servidor.");
            } finally {
                icon.classList.remove('animate-spin');
            }
        }

        function applyGlobalFilter() {
            if (!rawData) return;
            const unit = document.getElementById('global-unit-filter').value;
            const statusFilter = document.getElementById('filter-veh-status').value;
            const dFrom = document.getElementById('date-from').value;
            const dTo = document.getElementById('date-to').value;

            document.getElementById('display-unit').innerText = unit === 'ALL' ? 'UNIDAD NACIONAL' : unit;

            const matchesUnit = (item) => unit === 'ALL' || String(item.Unidad).toUpperCase() === unit.toUpperCase();
            
            const filteredVehiculos = rawData.vehiculos.filter(v => {
                const mU = matchesUnit(v);
                const mS = statusFilter === 'ALL' || String(v.Estado).toUpperCase() === statusFilter.toUpperCase();
                let mD = true;
                if(dFrom || dTo) {
                    const d = new Date(v.FechaReg);
                    if(dFrom && d < new Date(dFrom)) mD = false;
                    if(dTo && d > new Date(dTo)) mD = false;
                }
                return mU && mS && mD;
            });

            renderVehiculos(filteredVehiculos);
            renderArmamento(rawData.armamento.filter(matchesUnit));
            renderEquinos(rawData.equinos.filter(matchesUnit));
            renderCanes(rawData.canes.filter(matchesUnit));
            renderContratos(rawData.contratos.filter(matchesUnit));
            
            updateKPIs(filteredVehiculos);
            renderCharts(filteredVehiculos);
        }

        function updateKPIs(v) {
            const getCount = (s) => v.filter(x => String(x.Estado).toUpperCase() === s).length;
            document.getElementById('kpi-v-op').innerText = getCount('OPERATIVO');
            document.getElementById('kpi-v-maint').innerText = getCount('MANTENIMIENTO');
            document.getElementById('kpi-v-crash').innerText = getCount('SINIESTRADO');
            document.getElementById('kpi-v-parts').innerText = getCount('LOGISTICA');
            document.getElementById('kpi-v-budget').innerText = getCount('PRESUPUESTO');
            document.getElementById('kpi-v-held').innerText = getCount('RETENIDO');
        }

        function getStatusClass(status) {
            const s = String(status).toUpperCase();
            if(s.includes('OPERATIVO')) return 'bg-green-100 text-green-700';
            if(s.includes('MANTENIMIENTO')) return 'bg-purple-100 text-purple-700';
            if(s.includes('SINIESTRADO')) return 'bg-red-100 text-red-700';
            if(s.includes('LOGISTICA')) return 'bg-yellow-100 text-yellow-700';
            if(s.includes('PRESUPUESTO')) return 'bg-orange-100 text-orange-700';
            return 'bg-gray-100 text-gray-700';
        }

        function renderVehiculos(lista) {
            document.getElementById('tabla-vehiculos').innerHTML = lista.map(v => `
                <tr class="hover:bg-gray-50 border-b">
                    <td class="px-4 py-4"><div class="font-bold">${v.Placa || 'N/A'}</div><div class="text-[10px] uppercase">${v.Tipo || ''}</div></td>
                    <td class="px-4 py-4 text-xs"><div class="font-bold text-blue-700">${v.Unidad || ''}</div><div>${v.Zona || ''}</div></td>
                    <td class="px-4 py-4"><span class="status-badge ${getStatusClass(v.Estado)}">${v.SubEstado || v.Estado || 'N/A'}</span></td>
                    <td class="px-4 py-4 text-xs"><b>${v.Dias || 0}</b> días</td>
                    <td class="px-4 py-4 text-[11px] italic">${v.Observaciones || '-'}</td>
                </tr>
            `).join('');
        }

        function renderArmamento(lista) {
            document.getElementById('tabla-armamento').innerHTML = lista.map(a => `
                <tr class="hover:bg-gray-50 border-b text-xs">
                    <td class="px-4 py-3 font-bold">${a.Categoria || 'N/A'}</td>
                    <td class="px-4 py-3">${a.Tipo || 'N/A'}</td>
                    <td class="px-4 py-3 text-blue-700">${a.Unidad || 'N/A'}</td>
                    <td class="px-4 py-3 font-bold">${a.Cantidad || 0}</td>
                    <td class="px-4 py-3">${a.Estado || 'N/A'}</td>
                    <td class="px-4 py-3">${a.Vencimiento || 'N/A'}</td>
                </tr>
            `).join('');
        }

        function renderEquinos(lista) {
            document.getElementById('tabla-equinos').innerHTML = lista.map(e => `
                <tr class="hover:bg-gray-50 border-b text-xs">
                    <td class="px-4 py-3 font-bold">${e.ID || 'N/A'}</td>
                    <td class="px-4 py-3">${e.Raza || 'N/A'}</td>
                    <td class="px-4 py-3">${e.Unidad || 'N/A'}</td>
                    <td class="px-4 py-3"><span class="px-2 py-0.5 rounded bg-orange-100 text-orange-700">${e.Salud || 'N/A'}</span></td>
                </tr>
            `).join('');
        }

        function renderCanes(lista) {
            document.getElementById('tabla-canes').innerHTML = lista.map(c => `
                <tr class="hover:bg-gray-50 border-b text-xs">
                    <td class="px-4 py-3 font-bold">${c.ID || 'N/A'}</td>
                    <td class="px-4 py-3">${c.Especialidad || 'N/A'}</td>
                    <td class="px-4 py-3">${c.Unidad || 'N/A'}</td>
                    <td class="px-4 py-3"><span class="px-2 py-0.5 rounded bg-green-100 text-green-700">${c.Salud || 'N/A'}</span></td>
                </tr>
            `).join('');
        }

        function renderContratos(lista) {
            document.getElementById('tabla-contratos').innerHTML = lista.map(k => {
                const vencido = k.Fin && new Date(k.Fin) < today;
                return `
                <tr class="hover:bg-gray-50 border-b text-xs">
                    <td class="px-4 py-4 font-bold">${k.Objeto || 'N/A'}</td>
                    <td class="px-4 py-4">${k.Unidad || 'N/A'}</td>
                    <td class="px-4 py-4">${k.Inicio || ''}</td>
                    <td class="px-4 py-4 font-bold ${vencido ? 'text-red-600' : ''}">${k.Fin || ''}</td>
                    <td class="px-4 py-4"><span class="px-2 py-1 rounded text-[9px] font-bold ${vencido ? 'bg-red-100' : 'bg-green-100'}">${vencido ? 'VENCIDO' : 'ACTIVO'}</span></td>
                </tr>
            `}).join('');
        }

        function renderCharts(v) {
            const counts = (s) => v.filter(x => String(x.Estado).toUpperCase() === s).length;
            
            // Gráfico de Pastel (Estados)
            if(charts.pie) charts.pie.destroy();
            charts.pie = new Chart(document.getElementById('chartPieDetail'), {
                type: 'pie',
                data: {
                    labels: ['Op', 'Taller', 'Siniestro', 'Log', 'Presp', 'Ret'],
                    datasets: [{ data: [counts('OPERATIVO'), counts('MANTENIMIENTO'), counts('SINIESTRADO'), counts('LOGISTICA'), counts('PRESUPUESTO'), counts('RETENIDO')], backgroundColor: ['#10b981', '#8b5cf6', '#ef4444', '#f59e0b', '#f97316', '#0f172a'] }]
                },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } }
            });

            // Gráfico de Zonas
            const zones = {};
            v.forEach(x => zones[x.Zona] = (zones[x.Zona] || 0) + 1);
            if(charts.pieZones) charts.pieZones.destroy();
            charts.pieZones = new Chart(document.getElementById('chartPieZones'), {
                type: 'doughnut',
                data: { labels: Object.keys(zones), datasets: [{ data: Object.values(zones), backgroundColor: ['#3b82f6', '#06b6d4', '#8b5cf6', '#ec4899', '#f97316'] }] },
                options: { maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10 } } } }
            });

            // Gráfico de Barras (Unidades)
            const units = {};
            v.forEach(x => units[x.Unidad] = (units[x.Unidad] || 0) + 1);
            if(charts.bar) charts.bar.destroy();
            charts.bar = new Chart(document.getElementById('chartZones'), {
                type: 'bar',
                data: { labels: Object.keys(units), datasets: [{ label: 'Vehículos', data: Object.values(units), backgroundColor: '#3b82f6' }] },
                options: { maintainAspectRatio: false, scales: { y: { beginAtZero: true } } }
            });
        }

        window.onload = updateData;
    </script>
</body>
</html>
